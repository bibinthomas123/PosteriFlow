# ==============================================================================
# AHSD PRODUCTION CONFIG - REALISTIC O4/DESIGN LIGO SENSITIVITY
# Optimized for Neural PE & Priority Network Training
# Version: 2.0 - Physics-Validated Configuration
# Generated: 2025-11-06
# ==============================================================================

# ==============================================================================
# SECTION 1: CORE DATASET GENERATION PARAMETERS
# ==============================================================================

# Number of samples to generate (start with 50k for full training)
# STEP 4: K=5 means each unique parameter set gets 5 different noise realizations
# So n_samples=1000 with K=5 generates 5000 total samples
n_samples: 2000

# Output configuration
output_dir: "data/dataset2"
output_format: "pkl"  # Efficient binary format

# Batch size for saving samples to disk
save_batch_size: 100  # Larger batches = fewer I/O ops

# ==============================================================================
# SECTION 2: DATA CHARACTERISTICS
# ==============================================================================

# Detector sampling rate (Hz) - standard LIGO rate
sample_rate: 4096

# Duration of each sample (seconds)
duration: 4.0

# Active detectors (O4 configuration)
detectors:
  - H1  # LIGO Hanford
  - L1  # LIGO Livingston
  - V1  # Virgo

# ==============================================================================
# SECTION 3: SIGNAL COMPOSITION (REALISTIC FREQUENCIES)
# ==============================================================================

# Overlap fraction: ~30-40% is realistic for O4 detection rates
overlap_fraction: 0.45  # Increased for more overlapping samples

# Edge case fraction: Keep low to avoid correlation inflation
# edge_case_fraction: 0.02  # Reduced for faster testing (increase to 0.08 for production)

edge_case_fraction: 0.08 # for ( PRODUCTION )
# ==============================================================================
# SECTION 4: TRAIN/VALIDATION/TEST SPLITS
# ==============================================================================

create_splits: true

train_frac: 0.80
val_frac: 0.10
test_frac: 0.10

chunk_size: 100

max_overlapping_signals: 10

# ==============================================================================
# SECTION 5: SIGNAL PROCESSING OPTIONS
# ==============================================================================

# Realistic detector glitches (but not too many)
add_glitches: true  # Disabled for faster testing (enable for production)

# Always preprocess for ML training
preprocess: true

# STEP 4: Multi-noise augmentation (K=5)
# For each parameter set θ, generate K=5 different noise realizations
# This fixes distance bias by decoupling amplitude variation from distance
# Generates 1000 × 5 = 5000 total samples
noise_augmentation_k: 5

# Save minimal data for efficiency
save_complete: false

# ==============================================================================
# SECTION 6: REPRODUCIBILITY
# ==============================================================================

random_seed: 42  # Standard seed for reproducibility

# ==============================================================================
# SECTION 7: WAVEFORM CONFIGURATION
# ==============================================================================

approximant: "IMRPhenomXAS"  # Faster for testing (use IMRPhenomXAS for production)
f_ref: 20.0
f_lower: 20.0
f_upper: 1024.0

# ==============================================================================
# SECTION 8: REALISTIC SNR RANGES (O4 SENSITIVITY)
# ==============================================================================

snr_ranges:
  weak: [8.0, 12.0]     # Near detection threshold (ρth ~ 11-12)
  low: [12.0, 20.0]      # Low but confident detections
  medium: [20.0, 40.0]   # Typical detections (most events)
  high: [40.0, 70.0]     # Loud events
  loud: [70.0, 200.0]     # Very loud events


# Target SNR distribution (realistic O4 rates)
snr_distribution:
  weak: 0.05    # 5% near threshold
  low: 0.35     # 35% low SNR
  medium: 0.45  # 45% medium SNR (bulk)
  high: 0.12    # 12% high SNR
  loud: 0.03    # 3% very loud

# ==============================================================================
# SECTION 9: REALISTIC MASS RANGES
# ==============================================================================

mass_ranges:
  BBH: [5.0, 100.0]    # Observed range
  BNS: [1.0, 2.5]      # Neutron star masses
  NSBH: [1.0, 100.0]   # Mixed (NS: 1-2.5, BH: 3-100)

# ==============================================================================
# SECTION 10: REALISTIC DISTANCE RANGES (O4/DESIGN SENSITIVITY)
# ==============================================================================

# CRITICAL FIX: Wide distance ranges to prevent clipping (Dec 28, 17:35 UTC)
# With reference_distance=1300 Mpc, formulas need room to sample full range
# BBH: Allow 50-2000 Mpc (O4 horizon ~1000 Mpc, events up to 2840 Mpc)
# BNS: Allow 10-1000 Mpc (though most nearby ~100 Mpc, allow far samples for balance)
# NSBH: Allow 20-1500 Mpc (scales between BNS and BBH)
distance_ranges:
  BBH: [50.0, 5000.0]    # BBH: Wide range prevents clipping
  BNS: [10.0, 1000.0]    # BNS: Widened from [10, 180] to allow far samples
  NSBH: [20.0, 2000.0]   # NSBH: Widened from [20, 600] to allow far samples

# ==============================================================================
# SECTION 11: EVENT TYPE DISTRIBUTION (REALISTIC O4 RATES)
# ==============================================================================

event_type_distribution:
  BBH: 0.55   # 46% - most common detections
  BNS: 0.20   # 32% - rare but important
  NSBH: 0.20 # 17% - intermediate rate
  noise: 0.05 # 5% - noise-only samples

# ==============================================================================
# SECTION 12: PRE-MERGER CONFIGURATION (EARLY WARNING)
# ==============================================================================

premerger_config:
  enabled: true
  fraction: 0.08  # Reduced from 0.10 to 8%
  time_to_merger_range: [0.5, 3.0]  # Realistic early warning times
  event_types:
    - BNS   # Most relevant for early warning
    - NSBH
  min_snr: 8
  distance_range: [50, 400]  # Limit to O4 sensitivity range (prevents extreme SNR clipping)

# ==============================================================================
# SECTION 13: QUOTA MODE (BALANCED GENERATION)
# ==============================================================================

quota_mode: true
quota_max_attempts: 25
expected_signals_per_overlap: 3.8  # Realistic average
quota_joint_enforcement: true  # Enforce strict distributions
quota_include_extremes: true  # Allow heavy overlaps in quotas
quota_verbose: false  # Reduce log noise

# ==============================================================================
# SECTION 14: CALIBRATION
# ==============================================================================

calibration:
  enabled: true
  n_samples: 500
  random_seed: 42

# ==============================================================================
# SECTION 15: DEBUG OPTIONS
# ==============================================================================

debug_snr_diagnostic: false  # Disable for production
debug_snr_limit: 50

# ==============================================================================
# SECTION 16: EDGE CASES - REDUCED AND BALANCED
# ==============================================================================

edge_cases:
  # Physical extremes: 5% of total (down from 12%)
  physical_extremes:
    enabled: true
    fraction: 0.25  # 25% of edge cases = 2% of total dataset
    types:
      high_mass_ratio:
        fraction: 0.25
        q_range: [0.05, 0.15]  # Less extreme
      
      extreme_spins:
        fraction: 0.20
        spin_range: [0.80, 0.95]  # Moderate, not extreme
        aligned_fraction: 0.6
      
      eccentric_mergers:
        fraction: 0.15
        eccentricity_range: [0.02, 0.15]  # Low eccentricity
      
      precessing_systems:
        fraction: 0.25
      
      short_duration_high_mass:
        fraction: 0.15
        mass_range: [50, 80]  # Less extreme than 60-100
  
  # Observational extremes: 3% of total
  observational_extremes:
    enabled: true
    fraction: 0.25  # 25% of edge cases
    types:
      strong_glitches:
        fraction: 0.40
        glitch_prob: 0.6  # Reduced from 0.8
        glitch_types:
          - blip
          - scattered_light
      
      psd_drift:
        fraction: 0.25
        use_multiple_epochs: true
      
      detector_dropout:
        fraction: 0.20
        dropout_prob: 0.3  # Reduced from 0.4
      
      sky_position_extremes:
        fraction: 0.15
        use_uniform_sky: true
  
  # Statistical extremes: 2% of total
  statistical_extremes:
    enabled: true
    fraction: 0.20  # 20% of edge cases
    types:
      multimodal_posteriors:
        fraction: 0.40
      
      heavy_tailed_regions:
        fraction: 0.35
        log_uniform_distance: false  # Use volume weighting
      
      uninformative_priors:
        fraction: 0.25
        broad_prior_multiplier: 3.0  # Reduced from 8.0
        sample_intrinsic_params: false  # Keep priors realistic
  
  # Overlapping extremes: 2% of total
  overlapping_extremes:
    enabled: true
    fraction: 0.30  # 30% of edge cases
    types:
      subtle_ranking:
        fraction: 0.50  # Important for PriorityNet
        snr_difference_range: [0.5, 3.0]
      
      heavy_overlaps:
        fraction: 0.40
        n_signals_range: [3, 10]  # Allow up to 10 signals
      
      partial_overlaps:
        fraction: 0.20
        overlap_time_ms: [150, 600]

# ==============================================================================
# SECTION 17: EXTREME CASES - MINIMAL AND TARGETED
# ==============================================================================

# Extreme cases: Further reduced to 3% of dataset (down from 10%)
extreme_cases:
  enabled: true
  fraction: 0.03  # Only 3% of total samples
  types:
    # Keep only the most important extreme cases for robustness
    
    near_simultaneous_mergers:
      enabled: true
      fraction: 0.25
      delta_t_range: [0.1, 0.3]
      min_overlap: 2
      max_overlap: 3
      event_type_pairs:
        - ['BBH', 'BBH']
        - ['BNS', 'BNS']
    
    extreme_mass_ratio:
      enabled: true
      fraction: 0.15
      q_max: 0.08  # Less extreme
      q_range: [0.05, 0.08]
      total_mass_range: [15.0, 40.0]
    
    high_spin_aligned:
      enabled: true
      fraction: 0.15
      spin_min: 0.80
      spin_range: [0.80, 0.95]
      tilt_max: 0.4
    
    weak_strong_overlaps:
      enabled: true
      fraction: 0.25
      weak_snr_max: 12
      strong_snr_min: 25
      snr_ratio_min: 2.5
    
    noise_confused_overlaps:
      enabled: true
      fraction: 0.15
      n_signals: 2
      glitch_probability: 0.5
    long_duration_bns_overlaps:
      enabled: true
      fraction: 0.05
      f_lower_max: 15
      overlap_required: true
    
    detector_dropouts:
      enabled: false  # Disable to reduce complexity
    
    eccentric_overlaps:
      enabled: false  # Disable eccentric for cleaner dataset
    
    
    cosmological_distance:
      enabled: false  # Disable for realistic O4 sensitivity

# ==============================================================================
# SECTION 17.5: NEURAL NOISE GENERATION (FAST, ~10,000× SPEEDUP)
# ==============================================================================

neural_noise_enabled: true           # Enable fast neural noise generation
neural_noise_prob: 0.5               # 50% neural, 50% synthetic fallback
neural_model_type: "gaussian"        # "gaussian" (colored) or "noise" (realistic)
neural_device: "cuda"                # "cuda" or "cpu"

# Model paths (relative to project root)
neural_model_paths:
  H1: "data/Gaussian_network.pickle"
  L1: "data/Gaussian_network.pickle"
  V1: "data/Gaussian_network.pickle"

# Real noise configuration (uses pre-downloaded cache from gw_segments/)
use_real_noise_prob: 0.1  # 10% real noise (uses cached GWOSC data, no network overhead)
real_noise_cache_dir: "gw_segments"  # Directory with pre-downloaded segments {DETECTOR}_{TIMESTAMP}.npy

# ==============================================================================
# SECTION 18: VALIDATION THRESHOLDS
# ==============================================================================

validation:
  # Physics correctness checks
  inclination_isotropy_pvalue_min: 0.05  # KS test threshold
  
  # Mass-distance independence (detector-frame masses - physical Malmquist bias expected)
  # Source-frame masses are decoupled (< 0.02 correlation), detector-frame show physical bias
  mass_distance_correlation_max:
    BBH: 0.55   # Allow expected physical Malmquist bias (widest z-range)
    BNS: 0.35   # Stricter for BNS (shortest detection range)
    NSBH: 0.45  # Intermediate range
  
  
  # Minimum samples per event type
  min_samples_per_type:
    BBH: 100
    BNS: 50
    NSBH: 50
